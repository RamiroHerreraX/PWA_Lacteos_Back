openapi: 3.0.0
info:
  title: üéØ PWA Lacteos - API Documentation & Testing Matrix
  description: |
    # Sistema de Gesti√≥n de Usuarios con Autenticaci√≥n 2FA
    ## Descripci√≥n General
    
    ## üìã Matriz de Pruebas Integrada
    
    Esta documentaci√≥n sirve como herramienta para ejecutar la matriz de pruebas del sistema.
    
    ### Funcionalidades a probar:
    - ‚úÖ Autenticaci√≥n con verificaci√≥n en dos factores (2FA)
    - ‚úÖ Recuperaci√≥n de usuario y contrase√±a por roles
    - ‚úÖ Gesti√≥n de usuarios (Admin, Editor, Lector)
    - ‚úÖ Validaci√≥n de seguridad y roles
    
    ### Usuarios de prueba:
    - **Admin**: admin@mail.com / Admin123!
    - **Editor**: editor@mail.com / Editor123!  
    - **Lector**: lector@mail.com / Lector123!
    
    ### Flujos de prueba:
    1. Autenticaci√≥n ‚Üí 2FA ‚Üí Acceso
    2. Recuperaci√≥n ‚Üí OTP ‚Üí Restablecimiento
    3. CRUD usuarios seg√∫n rol
  version: 1.0.0
  contact:
    name: Equipo de Desarrollo
    email: desarrollo@lacteos.com

servers:
  - url: http://localhost:3000/api
    description: üß™ Servidor de Desarrollo y Pruebas

tags:
  - name: 1Ô∏è‚É£ Autenticaci√≥n 2FA
    description: Pruebas de login y verificaci√≥n en dos factores
  - name: 2Ô∏è‚É£ Recuperaci√≥n de Acceso
    description: Pruebas de recuperaci√≥n por roles (HU-02)
  - name: 3Ô∏è‚É£ Gesti√≥n de Usuarios
    description: Pruebas CRUD seg√∫n roles de usuario
  - name: üß™ Matriz de Pruebas
    description: Ejecuci√≥n guiada de casos de prueba

paths:
  # ==================== 1Ô∏è‚É£ AUTENTICACI√ìN 2FA ====================
  /login:
    post:
      tags: [1Ô∏è‚É£ Autenticaci√≥n 2FA]
      summary: TC-AUTH-001: Login con credenciales v√°lidas + 2FA
      description: |
        **Caso de prueba:** Autenticaci√≥n exitosa con verificaci√≥n en dos factores
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                  example: "admin@mail.com"
                password:
                  type: string
                  example: "Admin123!"
      responses:
        '200':
          description: ‚úÖ √âXITO - C√≥digo 2FA enviado al correo
        '400':
          description: ‚ùå ERROR - Credenciales incorrectas
        '500':
          description: ‚ö†Ô∏è ERROR - Problema en el servidor

  /verificar-otp:
    post:
      tags: [1Ô∏è‚É£ Autenticaci√≥n 2FA]
      summary: Verificar c√≥digo OTP
      description: Validar OTP y registrar geolocalizaci√≥n del inicio de sesi√≥n
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, otp]
              properties:
                email:
                  type: string
                  example: "admin@mail.com"
                otp:
                  type: string
                  example: "123456"
      responses:
        '200':
          description: ‚úÖ √âXITO - Autenticaci√≥n completada
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                  rol:
                    type: string
                  ubicacion:
                    type: object
                    properties:
                      ip:
                        type: string
                        example: "187.190.38.55"
                      country:
                        type: string
                        example: "MX"
                      city:
                        type: string
                        example: "Ciudad de M√©xico"
                      ll:
                        type: array
                        items:
                          type: number
                        example: [19.42847, -99.12766]
        '400':
          description: ‚ùå ERROR - OTP incorrecto o expirado

  # ==================== 2Ô∏è‚É£ RECUPERACI√ìN DE ACCESO ====================
  /reset/usuario:
    post:
      tags: [2Ô∏è‚É£ Recuperaci√≥n de Acceso]
      summary: TC-REC-001: Recuperar nombre de usuario
      responses:
        '200':
          description: ‚úÖ √âXITO - Usuario enviado al correo
        '404':
          description: ‚ùå ERROR - Correo no registrado

  /reset/enviar:
    post:
      tags: [2Ô∏è‚É£ Recuperaci√≥n de Acceso]
      summary: TC-REC-003/004: Solicitar recuperaci√≥n de contrase√±a
      responses:
        '200':
          description: ‚úÖ √âXITO - Proceso iniciado seg√∫n rol

  /reset/verificar-otp:
    post:
      tags: [2Ô∏è‚É£ Recuperaci√≥n de Acceso]
      summary: TC-REC-005: Verificar OTP para administradores
      responses:
        '200':
          description: ‚úÖ √âXITO - OTP verificado
        '400':
          description: ‚ùå ERROR - OTP incorrecto o expirado

  # ==================== 3Ô∏è‚É£ GESTI√ìN DE USUARIOS ====================
  /usuario:
    get:
      tags: [3Ô∏è‚É£ Gesti√≥n de Usuarios]
      summary: TC-USR-001/002/003: Listar usuarios
      responses:
        '200':
          description: ‚úÖ √âXITO - Lista de usuarios obtenida
        '500':
          description: ‚ùå ERROR - Problema en el servidor

  /usuario/nuevo:
    post:
      tags: [3Ô∏è‚É£ Gesti√≥n de Usuarios]
      summary: TC-USR-004: Crear nuevo usuario (solo Admin)
      responses:
        '201':
          description: ‚úÖ √âXITO - Usuario creado exitosamente
        '400':
          description: ‚ùå ERROR - Datos inv√°lidos
        '403':
          description: ‚ö†Ô∏è DENEGADO - Sin permisos

  # ==================== üìå HISTORIAL DE SESIONES ====================
  /usuario/sesiones:
    get:
      tags: [3Ô∏è‚É£ Gesti√≥n de Usuarios]
      summary: Consultar historial de sesiones del usuario autenticado
      description: Devuelve todas las sesiones registradas del usuario con IP, ubicaci√≥n y fecha
      security:
        - bearerAuth: []
      responses:
        '200':
          description: ‚úÖ √âXITO - Lista de sesiones
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: integer
                      example: 1
                    usuario_id:
                      type: integer
                      example: 5
                    ip:
                      type: string
                      example: "187.204.120.45"
                    ubicacion:
                      type: object
                      example:
                        country: "MX"
                        city: "CDMX"
                        ll: [19.4326, -99.1332]
                    fecha:
                      type: string
                      format: date-time
                      example: "2025-09-24T03:42:16Z"
        '401':
          description: ‚ùå Token requerido
        '403':
          description: ‚ùå Token inv√°lido
        '404':
          description: ‚ùå No hay historial de sesiones

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    Usuario:
      type: object
      properties:
        id:
          type: integer
          example: 1
        nombre:
          type: string
          example: "Admin User"
        email:
          type: string
          example: "admin@mail.com"
        rol:
          type: string
          example: "admin"
        creado_en:
          type: string
          format: date-time
          example: "2024-01-15T10:30:00Z"

  responses:
    Unauthorized:
      description: Token de acceso faltante o inv√°lido
    Forbidden:
      description: No tiene permisos para esta acci√≥n
